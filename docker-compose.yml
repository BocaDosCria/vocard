version: "3.9"

networks:
  vocard-swarm-net:
    external: true  # create as overlay + attachable (see commands below)
  dokploy-network:
    external: true

services:
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:latest
    environment:
      - _JAVA_OPTIONS=-Xmx1G
      - SERVER_PORT=2333
      - LAVALINK_SERVER_PASSWORD=youshallnotpass
      - PLUGINS_YOUTUBE_OAUTH_ENABLED=true
      - PLUGINS_YOUTUBE_OAUTH_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN}
      - PLUGINS_YOUTUBE_OAUTH_SKIPINITIALIZATION=true
    # Use Dokploy volume instead of bind
    volumes:
      - vocard-lavalink-config:/opt/Lavalink
    networks:
      - vocard-swarm-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --header='Authorization: youshallnotpass' --tries=1 --spider http://127.0.0.1:2333/v4/info || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 10
      update_config:
        order: start-first
        parallelism: 1
        delay: 5s

  spotify-tokener:
    image: ghcr.io/topi314/spotify-tokener:master
    environment:
      - SPOTIFY_TOKENER_ADDR=0.0.0.0:49152
    networks:
      - vocard-swarm-net
    ports:
      - target: 49152
        published: 49152
        protocol: tcp
        mode: ingress
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 49152"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      update_config:
        order: start-first
        parallelism: 1

  vocard-db:
    image: mongo:8
    command: ["mongod", "--oplogSize=1024", "--wiredTigerCacheSizeGB=1", "--auth", "--noscripting"]
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin
    # Use Dokploy volumes instead of bind mounts
    volumes:
      - vocard-mongo-db:/data/db
      - vocard-mongo-conf:/data/configdb
    networks:
      - vocard-swarm-net
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.runCommand({ping:1}).ok' | mongosh localhost:27017/test --quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      update_config:
        order: stop-first
        parallelism: 1

  vocard-dashboard:
    image: ghcr.io/chocomeow/vocard-dashboard:latest
    volumes:
      - ../files/dashboard/settings.json:/app/settings.json:ro
    networks:
      - vocard-swarm-net
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.vocard-dashboard.rule=Host(`music.caikovsky.cloud`)
      - traefik.http.routers.vocard-dashboard.entrypoints=web
      - traefik.http.routers.vocard-dashboard.middlewares=redirect-to-https
      - traefik.http.routers.vocard-dashboard-secure.rule=Host(`music.caikovsky.cloud`)
      - traefik.http.routers.vocard-dashboard-secure.entrypoints=websecure
      - traefik.http.routers.vocard-dashboard-secure.tls.certresolver=letsencrypt
      - traefik.http.services.vocard-dashboard.loadbalancer.server.port=8000
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      update_config:
        order: start-first
        parallelism: 1

  vocard:
    image: ghcr.io/chocomeow/vocard:latest
    volumes:
      - type: bind
        source: ../files/settings.json
        target: /app/settings.json
        bind:
          create_host_path: false
    networks:
      - vocard-swarm-net
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      update_config:
        order: start-first
        parallelism: 1

volumes:
  vocard-mongo-db:
    external: true
  vocard-mongo-conf:
    external: true
  vocard-lavalink-config:
    external: true